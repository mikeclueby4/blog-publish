---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => data.draft === false);
  const tagSet = new Set(posts.flatMap((p) => p.data.tags));
  return [...tagSet].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.filter((p) => p.data.tags.includes(tag)),
    },
  }));
}

const { tag, posts } = Astro.props;
const sorted = [...posts].sort(
  (a, b) => (b.data.date?.getTime() ?? 0) - (a.data.date?.getTime() ?? 0)
);
---

<Layout
  title={`${tag} | Privileged Contexts`}
  description={`Posts tagged ${tag}`}
>
  <main>
    <a class="back" href="/">‚Üê All posts</a>
    <h1>#{tag}</h1>
    <ul class="post-list">
      {sorted.map((post) => (
        <li>
          <a href={`/${post.data.slug}/`}><h2>{post.data.title}</h2></a>
          {post.data.date && (
            <time datetime={post.data.date.toISOString()}>
              {post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
          )}
          {post.data.description && <p>{post.data.description}</p>}
        </li>
      ))}
    </ul>
  </main>
</Layout>

<style>
  main { max-width: 780px; margin: 0 auto; padding: 2rem 1rem; }
  .back { display: inline-block; color: #64748b; text-decoration: none; font-size: 0.9rem; margin-bottom: 1rem; }
  .back:hover { color: #e2e8f0; }
  h1 { font-size: 1.75rem; margin: 0.5rem 0 1.5rem; }
  .post-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1.5rem; }
  .post-list li { border-bottom: 1px solid #1e293b; padding-bottom: 1.5rem; }
  .post-list li:last-child { border-bottom: none; }
  .post-list h2 { margin: 0 0 0.25rem; font-size: 1.15rem; }
  .post-list a { color: #e2e8f0; text-decoration: none; }
  .post-list a:hover { text-decoration: underline; }
  time { font-size: 0.85rem; color: #64748b; }
  p { color: #94a3b8; margin: 0.4rem 0 0; }
</style>
